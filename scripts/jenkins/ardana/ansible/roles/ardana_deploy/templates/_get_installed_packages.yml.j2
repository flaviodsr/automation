#
# (c) Copyright 2018 SUSE LLC
#
# Licensed under the Apache License, Version 2.0 (the "License"); you may
# not use this file except in compliance with the License. You may obtain
# a copy of the License at
#
# http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS, WITHOUT
# WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the
# License for the specific language governing permissions and limitations
# under the License.
#
---
{% raw %}
- name: Get list of installed packages
  hosts: "resources:!*rhel*{{':!ARD-SVC--first-member' if state == 'pre' else '' }}"
  become: yes
  vars:
{% endraw %}
    pkg_report_dir: "{{ pkg_report_dir }}"

{% raw %}
  tasks:
    - name: Get repositories
      shell: zypper lr -d
      args:
        warn: False
      register: _zypp_repos
      changed_when: false

    - name: Save zypper repos
      copy:
        content: "{{ hostvars[item]._zypp_repos.stdout }}"
        dest: "{{ pkg_report_dir }}/repos-{{ state }}-deploy-{{ (item in groups['ARD-SVC--first-member']) | ternary('deployer', item) }}.txt"
      with_items: "{{ play_hosts }}"
      delegate_to: localhost

    - name: Get installed packages list
      shell: |
        zypper se -s --sort-by-name --installed-only | grep 'noarch\|x86_64' \
          | awk -F "|" '{ print $2 $4 $6 }' | sed 's/^[ \t]*//;s/[ \t]*$//'
      args:
        warn: False
      register: _pkg_list
      changed_when: false

    - name: Save installed packages list
      copy:
        content: "{{ hostvars[item]._pkg_list.stdout }}"
        dest: "{{ pkg_report_dir }}/pkgs-{{ state }}-deploy-{{ (item in groups['ARD-SVC--first-member']) | ternary('deployer', item) }}.txt"
      with_items: "{{ play_hosts }}"
      delegate_to: localhost
{% endraw %}
